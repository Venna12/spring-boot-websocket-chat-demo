on: [push]

name: visual-testing-cicd

jobs:
  deployMicroservicesDev:
    runs-on: self-hosted
    env:
      TEST_START_PAGE: ghchattybot-dev.k8s.az.jessicadeen.com
    steps:
      # - name: Applitools Build Task
      #   run: |
      #     # set batch ID
      #     APPLITOOLS_BATCH_ID=${{ github.run_id }}

      #     echo "::set-env name=APPLITOOLS_BATCH_ID::${{ github.run_id }}"
          
      #     echo "Setting environment variable APPLITOOLS_BATCH_ID: $APPLITOOLS_BATCH_ID"

      #     # set batch name
      #     APPLITOOLS_BATCH_NAME="GitHub Actions / ${{ github.workflow }}"

      #     echo "::set-env name=APPLITOOLS_BATCH_NAME::GitHub Actions / ${{ github.workflow }}"
          
      #     echo "Setting environment variable APPLITOOLS_BATCH_NAME: $APPLITOOLS_BATCH_NAME"

      #     # set server url
      #     APPLITOOLS_SERVER_URL="https://eyes.applitools.com"

      #     echo "::set-env name=APPLITOOLS_SERVER_URL::https://eyes.applitools.com"
          
      #     echo "Setting environment variable APPLITOOLS_SERVER_URL: $APPLITOOLS_SERVER_URL"

      #     # set batch sequence
      #     APPLITOOLS_BATCH_SEQUENCE="GitHub Actions / ${{ github.workflow }}"

      #     echo "::set-env name=APPLITOOLS_BATCH_SEQUENCE::GitHub Actions / ${{ github.workflow }}"
          
      #     echo "Setting environment variable APPLITOOLS_BATCH_SEQUENCE: $APPLITOOLS_BATCH_SEQUENCE"
      
      # - name: "Setup JDK"
      #   uses: actions/setup-java@v1
      #   with:
      #     java-version: '13'
      - name: Install Selenium
        run: |
            sudo pip3 install selenium
      - name: ChromeWebDriver
        run: |
            cat <<EOF >> test.py
            from selenium import webdriver
            from selenium.webdriver.chrome.options import Options
            options = Options()
            options.add_argument("--headless")
            options.add_argument('--no-sandbox')
            options.add_argument('--disable-gpu')
            options.add_argument('--disable-dev-shm-usage')
            options.add_argument('disable-infobars')
            options.add_argument("--disable-extensions")
            driver = webdriver.Chrome(chrome_options=options, executable_path='/usr/bin/chromedriver')
            driver.get("http://github.com/")
            print ('Page title is ' + driver.title)
            EOF
            
            python3 test.py
            
      - name: git checkout branch
        uses: actions/checkout@v2
        with:
          ref: applitools

      - uses: actions/setup-java@v1
        with:
          java-version: '13'
          architecture: x64
          jdkFile: /usr/lib/jvm/java-13-oracle

      - name: "Visual Testing"
        env:
          APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}    
        run: mvn -f visual_tests/pom.xml clean test test
